<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script type="text/javascript" src="//d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src="js/third-party/MidiConvert.js"></script>
<script type="text/javascript" src="js/third-party/Tone.js"></script>
<link rel="stylesheet" type="text/css" href="css/style.css">
<style>
</style>
</head>
<body>
<button>play</button>
<div id="freqChart"></div>
<div id="radChart"></div>
<div id="scrollChart"></div>
<script>
let scrollChartSvg, scaleScrollX;
let midiData, noteData, stackedData; // lazy globals for browser runtime coding
const NOTES = ["A", "As", "B", "C", "Cs", "D", "Ds", "E", "F", "Fs", "G", "Gs"];
const BEAT_RESOLUTION = 16;

function getNoteLetter(note) {
  return note.name.slice(0,-1).replace('#','s');
}

function getNoteId(note) {
  return `${note.name}-${note.time}`.replace('#','s').replace('.','-')
}

MidiConvert.load("bwv-846.midi").then(function(midi){
  midiData = midi;
  let bpMeasure = midiData.header.timeSignature[0];
  let bpMinute = midiData.header.bpm;
  let beatPeriod = (bpMinute / 60);
  let measurePeriod = bpMeasure * beatPeriod;
  let measureResolution = bpMeasure * BEAT_RESOLUTION;
  let facetLength = measurePeriod / measureResolution;

  let notes = midiData.tracks[1].notes.concat(midiData.tracks[2].notes);
  noteData = notes.map(function(n){ return Object.assign(n, {
      id: getNoteId(n),
      keyNumber: parseInt(n.midi),
      letter: getNoteLetter(n),
      time: n.time,
      measure: parseInt(n.time / measurePeriod),
      measureFacet: parseInt((n.time % measurePeriod) / facetLength)
  }); });

  stackedData = stackNotesByFacet(noteData);
  plotRadialChart(stackedData, measureResolution);
  plotFreqChart(noteData);
  plotScrollChart(noteData);
  prepAudio(midi);
});

function stackNotesByFacet(noteData) {
  let nestByFacet = d3.nest().key(function(n){ return n.measureFacet });

  function rollupNoteFreq(d){ return d.reduce(function(noteCounts,facet){
    noteCounts[facet.letter] = noteCounts[facet.letter] || 0;
    noteCounts[facet.letter]++;
    return noteCounts;
  },{})}

  function sortAscKey(a,b){return parseInt(a.key) - parseInt(b.key)}

  function flattenFacet(facet){
    return Object.assign(facet.value, { facetIndex: parseInt(facet.key) });
  }

  let dataNest = nestByFacet.rollup(rollupNoteFreq).entries(noteData)
                  .sort(sortAscKey).map(flattenFacet);

  let stack = d3.stack()
    .keys(NOTES).value(function(d,key){ return d[key] || 0 })
    .offset(d3.stackOffsetNone);

  return stack(dataNest);
}

function plotScrollChart(noteData){
  function minSecFmt(seconds){
    let min = parseInt(seconds / 60);
    let sec = parseInt(seconds % 60);
    return (min + ":" + (sec < 10 ? '0' : '') + sec);
  }

  var margin = {top: 20, right: 20, bottom: 30, left: 40},
      width = 700 - margin.left - margin.right,
      height = 150 - margin.top - margin.bottom;

  scaleScrollX = d3.scaleLinear().range([0, width]);
  let scaleScrollY = d3.scaleLinear().range([height, 0]);

  var xAxis = d3.axisBottom(scaleScrollX).tickFormat(minSecFmt),
      yAxis = d3.axisLeft(scaleScrollY);

  var brush = d3.brushX()
    .extent([[0, 0], [width, height]])
    .on("brush", brushed);

  scrollChartSvg = d3.select("#scrollChart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

  scrollChartSvg.append("defs").append("clipPath")
      .attr("id", "clip")
    .append("rect")
      .attr("width", width)
      .attr("height", height);

  var context = scrollChartSvg.append("g")
    .attr("class", "context");

  scaleScrollX.domain(d3.extent(noteData, function(d) { return d.time; }));
  scaleScrollY.domain([d3.min(noteData, function(d) { return d.keyNumber; })-2, 
            d3.max(noteData, function(d) { return d.keyNumber; })+2 ]);

  var dots = context.append("g");
    dots.attr("clip-path", "url(#clip)");
    dots.selectAll(".dots")
        .data(noteData)
        .enter().append("rect")
        .attr('class', function(n) { return 'dot' + ' n' + n.letter })
        .attr('id', function(n){return n.id})
        .style("opacity", .5)
        .attr("x", function(n) { return scaleScrollX(n.time) })
        .attr("y", function(n) { return scaleScrollY(n.keyNumber) })
        .attr("width", function(n) { return scaleScrollX(n.noteOff) - scaleScrollX(n.noteOn) })
        .attr("height", 4);
            
    context.append("g")
          .attr("class", "axis axis--x")
          .attr("transform", "translate(0," + height + ")")
          .call(scaleScrollX);

    context.append("g")
          .attr("class", "brush")
          .call(brush)
          .call(brush.move, scaleScrollX.range());

    context.append("line")
        .attr("id", "playHead")
        .attr("x1", scaleScrollX(0))
        .attr("y1", 95)
        .attr("x2", scaleScrollX(0))
        .attr("y2", -5)
        .style("opacity", .3)
        .style("stroke", "black");

    //create brush function redraw midiplot with selection
  function brushed() {
    var selection = d3.event.selection;
    scaleScrollX.domain(selection.map(scaleScrollX.invert, scaleScrollX));
    // ^ gives [selectionStartTime, selectionEndTime]
  }
}

function fmtFreqData(noteData) {
  return d3.nest().key(function(n){ return n.letter })
    .rollup(function(notes){ return notes.length })
    .entries(noteData);
  plotFreqChart(freqData);
}

function plotFreqChart(noteData){
  let data = fmtFreqData(noteData);
  var margin = {top: 20, right: 20, bottom: 30, left: 40},
      width = 500 - margin.left - margin.right,
      height = 300 - margin.top - margin.bottom;

  var freqChartXScale = d3.scaleBand().range([0, width]).padding(0.1);
  var freqChartYScale = d3.scaleLinear().range([height, 0]);

  var freqChartSvg = d3.select("#freqChart").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g").attr("transform","translate(" + margin.left + "," + margin.top + ")");

  freqChartXScale.domain(NOTES);
  freqChartYScale.domain([0, d3.max(data, function(d) { return d.value; })]);

  freqChartSvg.selectAll(".bar")
      .data(data)
    .enter().append("rect")
      .attr('class', function(d) { return 'bar' + ' n' + d.key; })
      .attr("x", function(d) { return freqChartXScale(d.key); })
      .attr("width", freqChartXScale.bandwidth())
      .attr("y", function(d) { return freqChartYScale(d.value); })
      .attr("height", function(d) { return height - freqChartYScale(d.value); });

  freqChartSvg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(freqChartXScale));

  freqChartSvg.append("g")
      .call(d3.axisLeft(freqChartYScale));

};

function plotRadialChart(stackedData, facetCount) {
  var margin = {top: 20, right: 20, bottom: 30, left: 40},
      width = 500 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

  var radChartSvg = d3.select("#radChart").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g").attr("transform","translate(" + (margin.left + width/2) + "," + (margin.top + height/2) + ")");

  var ang = d3.scaleLinear().range([0 , 2 * Math.PI]);
  var rad = d3.scaleLinear().range([20, 40]);
  ang.domain([0,facetCount - 1]);

  var radialAreaByMeasure = d3.radialArea()
      .curve(d3.curveBasisClosed)
      .angle(function(d, i) { return ang(d.data.facetIndex) })
      .innerRadius(function(d, i) { return rad(d[0]) })
      .outerRadius(function(d, i) { return rad(d[1]) });

  radChartSvg.selectAll(".layer")
    .data(stackedData)
    .enter().append("g")
    .attr("class", "layer")
    .append("path")
    .attr("class", function(d){return "area" + " n" + d.key})
    .attr("d", radialAreaByMeasure);
}

/// audio playback
var button = document.querySelector("button");
button.addEventListener("click", function(){
  if (Tone.Transport.state === "started"){
    Tone.Transport.stop();
    button.textContent = "play";
  } else {
    Tone.Transport.start("+0.1", 0);
    button.textContent = "STOP";
  }
});

function prepAudio(midi, noteData){
  Tone.Transport.bpm.value = midi.bpm;
  Tone.Transport.timeSignature = midi.timeSignature;

  synth = new Tone.PolySynth(8, Tone.Synth, {
    "oscillator": {
      "type": "sine3"
    },
    "envelope": {
      "attack": 0.03,
      "decay": 0.1,
      "sustain": 0.2,
      "release": 0.6
    }
  }).toMaster();

  let rightHand = midi.get("Piano right").notes;
  let leftHand = midi.get("Piano left").notes;
  let rightHandPart = new Tone.Part(playNote, rightHand).start(0);
  let leftHandPart = new Tone.Part(playNote, leftHand).start(0);
  // let allNotes = midi.tracks.reduce(function(notes, track){
  //   if(!track.isPercussion){
  //     notes = notes.concat(track.notes);
  //   }
  //   return notes;
  // },[]);
  // let allParts = new Tone.Part(playNote, allNotes).start(0);
  //let noteDataPart = new Tone.Part(playNote, noteData).start(0);

  button.classList.add("active");
}

function playNote(time, event){
  synth.triggerAttackRelease(event.name, event.duration, time, event.velocity);
  d3.select('#playHead')
      .attr("x1", scaleScrollX(event.time))
      .attr("x2", scaleScrollX(event.time))
  scrollChartSvg.select(`#${event.id}`)
    .style('opacity',1).attr('height',6)
    .transition().duration(event.duration * 1000)
    .style('opacity',0.5).attr('height',4);

  //setTimeout(function(){svg.select(`#key${event.midi}`).transition().attr('fill', 'none')}, event.duration * 1000);
  //console.log(event);
}

</script>
</body>
</html>